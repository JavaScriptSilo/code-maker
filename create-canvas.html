<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Code Maker</title>
  <link rel="stylesheet" href="createCanvas.css"/>
</head>
<body>
  <div class="topBar">
    <a href="index.html" id="homelink">Home</a>
  </div>

  <div class="controls" id="canvasControls">
    <input type="text" id="heightInput" placeholder="Enter Height">
    <button id="setHeight">Set Height</button>
    <input type="text" id="widthInput" placeholder="Enter Width">
    <button id="setWidth">Set Width</button>
    <input type="text" id="backgroundInput" placeholder="Enter Background Color">
    <button id="setBackground">Set Background</button>
    <input type="text" id="squareSizeInput" placeholder="Enter Square Size">
    <button id="squareSize">Change Square Size</button>
    <input type="text" id="msBetweenFramesInput" placeholder="Set Milliseconds"></input>
    <button id="msBetweenFramesButton">Set Time In Between Frames</button>
    <button id="drawToggle">Toggle Square Drawing</button>
    <button id="newCanvas">New Frame</button>
    <button id="dupLastCanvas">Duplicate Last Canvas</button>
    <button id="clearCanvas">Clear Canvas</button>
  </div>
 
  <div id="canvasContainer"></div>

  <div id="codeBoxesContainer">
    <div id="codeBox">
        <button class="copyBtn" data-target="codeText">Copy HTML Code</button>
        <p id="codeText"></p>
    </div>

    <div id="codeBoxTwo">
        <button class="copyBtn" data-target="codeTextTwo">Copy Frame Code</button>
        <p id="codeTextTwo"></p>
    </div>
  </div>

<script src="createCanvasCopyButtonCode.js"></script>

<script>
  const canvasWidthDefault = 500;
  const canvasHeightDefault = 300;
  let canvasWidth = canvasWidthDefault;
  let canvasHeight = canvasHeightDefault;
  let canvasBackground = "none";
  let isDrawing = false;
  let squares = [];
  let clearRectArray = [];
  let size = 50; // Default square size
  let canvases = [];
  let activeCanvasId = null;
  let ffArray = [];
  let frameNum = 0;
  let msBetweenFrames = 500;
  let isMouseDown = false;
  ffArray.push("frame0");

  function createBox() {
      const canvas = document.createElement("canvas");
      canvas.id = "canvas0";
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      canvas.style.border = "1px solid black";
      canvas.style.backgroundColor = canvasBackground === "" ? "powderblue" : canvasBackground;

      canvas.onclick = () => {
          activeCanvasId = canvas.id;
          canvases.forEach(c => {
          document.getElementById(c.id).style.boxShadow = "none";
          });
          canvas.style.boxShadow = "0 0 10px 2px yellow";
          createCode();
      };

      document.getElementById("canvasContainer").innerHTML = '';
      document.getElementById("canvasContainer").appendChild(canvas);

      // Track the canvas
      canvases = [{
          id: canvas.id,
          squares: [],
          size: size,
          background: canvasBackground
      }];

    activeCanvasId = canvas.id;
  }


  function setupControls() {
    document.getElementById("setWidth").onclick = () => {
      const newWidth = parseInt(document.getElementById("widthInput").value);
      if (isNaN(newWidth) || !activeCanvasId) return;

      const canvas = document.getElementById(activeCanvasId);
      const ctx = canvas.getContext("2d");

      // Save current image
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      // Resize canvas
      canvas.width = newWidth;

      // Restore image
      ctx.putImageData(imageData, 0, 0);

      const canvasData = canvases.find(c => c.id === activeCanvasId);
      canvasData.width = newWidth;
      canvasWidth = newWidth;

      createCode(canvasData);
};


    document.getElementById("setHeight").onclick = () => {
      const newHeight = parseInt(document.getElementById("heightInput").value);
      if (isNaN(newHeight) || !activeCanvasId) return;

      const canvas = document.getElementById(activeCanvasId);
      const ctx = canvas.getContext("2d");

      // Save current image
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      // Resize canvas
      canvas.height = newHeight;

      // Restore image
      ctx.putImageData(imageData, 0, 0);

      const canvasData = canvases.find(c => c.id === activeCanvasId);
      canvasData.height = newHeight;
      canvasHeight = newHeight;

      createCode(canvasData);
    };
    
    document.getElementById("setBackground").onclick = () => {
        const color = document.getElementById("backgroundInput").value.trim().toLowerCase();
        const validColors = new Set(["white", "black", "red", "orange", "yellow", "green", "blue", "purple", "none"]);

        if (!activeCanvasId || !validColors.has(color)) return;

        const canvas = document.getElementById(activeCanvasId);
        const canvasData = canvases.find(c => c.id === activeCanvasId);

        const finalColor = color === "none" ? "powderblue" : color;
        canvas.style.backgroundColor = finalColor;
        canvasData.background = finalColor;

        createCode(canvasData);
    };

    document.getElementById("drawToggle").onclick = () => {
  	isDrawing = !isDrawing;
    };
   
    document.getElementById("squareSize").onclick = () => {
      const newSize = parseInt(document.getElementById("squareSizeInput").value);
      if (!isNaN(newSize)) {
        size = newSize;
        createCode();
      }
    };

    document.getElementById("clearCanvas").onclick = () => {
        if (!activeCanvasId) return;
        const canvas = document.getElementById(activeCanvasId);
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const canvasData = canvases.find(c => c.id === activeCanvasId);
        canvasData.squares = [];
        clearRectArray = [];

        createCode(canvasData);
    };

    let idNum = 0;
    let newFrameBttn = document.getElementById("newCanvas");
    newFrameBttn.onclick = function() {
        idNum += 1;
        ffArray.push(` frame${frameNum + 1}`);
        frameNum += 1;
        const canvas = document.createElement("canvas");
        canvas.id = `canvas${idNum}`;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        canvas.style.border = "1px solid black";
        canvas.style.marginTop = "30px";
        canvas.style.backgroundColor = canvasBackground === "" ? "powderblue" : canvasBackground;

        canvas.onclick = () => {
            activeCanvasId = canvas.id;
            canvases.forEach(c => {
                document.getElementById(c.id).style.boxShadow = "none";
            });
            canvas.style.boxShadow = "0 0 10px 2px yellow";
            createCode();
        };

        canvases.push({
            id: canvas.id,
            squares: [],
            size: size,
            background: canvasBackground,
            width: canvasWidth,
            height: canvasHeight
        });

        document.getElementById("canvasContainer").appendChild(canvas);
        activeCanvasId = canvas.id;
      createCode();
    };

    document.getElementById("msBetweenFramesButton").onclick = function () {
        msBetweenFrames = document.getElementById("msBetweenFramesInput").value;
    };
    
    document.getElementById("dupLastCanvas").onclick = function() {
        if (canvases.length === 0) return; // No canvas to duplicate

        idNum += 1;
        ffArray.push(` frame${frameNum}`);
        frameNum += 1;

        // Get the last canvas and its data
        const lastCanvasData = canvases[canvases.length - 1];
        const lastCanvas = document.getElementById(lastCanvasData.id);

        // Create new canvas element
        const canvas = document.createElement("canvas");
        canvas.id = `canvas${idNum}`;
        canvas.width = lastCanvas.width;
        canvas.height = lastCanvas.height;
        canvas.style.border = "1px solid black";
        canvas.style.marginTop = "30px";
        canvas.style.backgroundColor = lastCanvas.style.backgroundColor;

        // Copy visual content
        const ctx = canvas.getContext("2d");
        ctx.drawImage(lastCanvas, 0, 0);

        // Copy metadata
        const copiedSquares = lastCanvasData.squares.map(sq => ({ ...sq }));
        const copiedSize = lastCanvasData.size;
        const copiedBackground = lastCanvasData.background;

        // Add click behavior
        canvas.onclick = () => {
            activeCanvasId = canvas.id;
            canvases.forEach(c => {
            document.getElementById(c.id).style.boxShadow = "none";
            });
            canvas.style.boxShadow = "0 0 10px 2px yellow";
            createCode();
        };

        // Add to DOM and data array
        document.getElementById("canvasContainer").appendChild(canvas);
        canvases.push({
            id: canvas.id,
            squares: copiedSquares,
            size: copiedSize,
            background: copiedBackground,
            width: canvas.width,
            height: canvas.height
        });

        activeCanvasId = canvas.id;
        createCode();
    };
    
  }

  function createCode(canvasData = canvases.find(c => c.id === activeCanvasId)) {
    if (!canvasData) return;

    let squareCode = canvasData.squares.map(sq => `ctx.fillRect(${sq.x}, ${sq.y}, ${sq.s}, ${sq.s});`).join("<br>");
    let frameCode = `ctx.clearRect(0, 0, ${canvasWidth}, ${canvasHeight});<br>${squareCode}`;

    // Store this frame's code in the array
    const existingIndex = clearRectArray.findIndex(entry => entry.id === canvasData.id);
    if (existingIndex !== -1) {
      clearRectArray[existingIndex].code = frameCode;
    } else {
      clearRectArray.push({ id: canvasData.id, code: frameCode });
    }
    
    // Display all frame codes in codeBoxTwo
     let combinedCode = clearRectArray.map((entry, index) => {
       return `function frame${index} () {<br>${entry.code}<br>} ;<br>`;
     }).join("");

    // Display full HTML code in codeBox
    let fullCode = `&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;&lt;/head&gt;<br>&lt;body&gt;<br>&lt;script&gt;<br>
      const canvas = document.createElement('canvas');<br>
      const ctx = canvas.getContext("2d");<br>
      canvas.width = ${canvasWidth};<br>
      canvas.height = ${canvasHeight};<br>
      canvas.style.backgroundColor = '${canvasData.background}';<br>
      ctx.fillStyle = "black";<br>
      ${combinedCode}
      const frames = [${ffArray}];<br>
      for (let i = 0; i < 1000; i++) {<br>
      setTimeout(() => {<br>
      frames[i % frames.length]();<br>
      }, i * ${msBetweenFrames});<br>
      };<br>
      document.body.appendChild(canvas);<br>
      &lt;/script&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;`;
      document.getElementById("codeText").innerHTML = fullCode;

     document.getElementById("codeTextTwo").innerHTML = combinedCode;
  }

  function setupDragDrawing() {
  const canvasContainer = document.getElementById("canvasContainer");

  canvasContainer.addEventListener("mousedown", function(e) {
    if (!isDrawing || !activeCanvasId) return;
    if (e.target.tagName !== "CANVAS") return;
    isMouseDown = true;
    drawSquare(e);
  });

  window.addEventListener("mouseup", function() {
    isMouseDown = false;
  });

  canvasContainer.addEventListener("mousemove", function(e) {
    if (!isDrawing || !activeCanvasId || !isMouseDown) return;
    if (e.target.tagName !== "CANVAS") return;
    drawSquare(e);
  });
}

// Helper function to draw a square at the mouse position
function drawSquare(e) {
  const canvas = document.getElementById(activeCanvasId);
  const ctx = canvas.getContext("2d");
  const rect = canvas.getBoundingClientRect();
  const rectX = e.clientX - rect.left - size / 2;
  const rectY = e.clientY - rect.top - size / 2;

  ctx.fillStyle = "black";
  ctx.fillRect(rectX, rectY, size, size);

  const canvasData = canvases.find(c => c.id === activeCanvasId);
  canvasData.squares.push({x: rectX, y: rectY, s: size});
  createCode(canvasData);
}

  window.onload = () => {
    createBox();
    setupControls();
    setupDragDrawing();
    createCode();
};

</script>
</body>
</html>
